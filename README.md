# 爱岛捎带应用开发文档

## 项目概述
爱岛捎带是一个专注于国际捎带服务的小程序，连接有捎带需求的用户和可以提供捎带服务的用户。用户可以在平台上发布捎带需求或提供捎带服务，实现物品的跨国捎带。

### 目标用户
- 经常在中爱两地往返的旅客
- 需要跨境邮寄但不想支付高额物流费用的用户
- 想要通过捎带赚取额外收入的用户

### 核心功能
- **用户系统**：用户注册、登录、实名认证
- **捎带匹配**：用户发布需求，平台智能匹配可提供服务的人
- **支付系统**：支持担保交易，保障双方权益
- **消息中心**：支持即时聊天，沟通捎带细节
- **评价体系**：交易完成后用户可互相评分，提高服务质量

## 系统架构

### 整体架构
```
┌────────────────────────────────────────────────────┐
│                      微信小程序客户端                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │ 用户模块 │  │ 捎带模块 │  │ 支付模块 │  │ 消息模块 │  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │
└──────────────────────────┬──────────────────────┘
                           ↓
┌────────────────────────────────────────────────────┐
│                      云开发平台                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 云函数    │  │ 云数据库  │  │ 云存储    │  │ 云托管服务 │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└──────────────────────────┬──────────────────────┘
                           ↓
┌────────────────────────────────────────────────────┐
│                      第三方服务集成                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 支付系统  │  │ 身份认证  │  │ 消息推送  │  │ 地理定位  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────────────────────────────────────┘
```

### 数据流图
```
┌──────────┐    认证     ┌──────────┐    发布需求   ┌──────────┐
│          │ ─────────→ │          │ ─────────→ │          │
│   用户    │            │  用户系统  │            │ 捎带系统  │
│          │ ←───────── │          │ ←───────── │          │
└──────────┘  用户信息   └──────────┘   需求列表   └──────────┘
                                             ↑ │
                                  接单确认   │ │  捎带服务
                                             │ ↓
┌──────────┐    支付     ┌──────────┐    订单生成   ┌──────────┐
│          │ ─────────→ │          │ ←───────── │          │
│ 支付系统  │            │  订单系统  │            │ 物流系统  │
│          │ ←───────── │          │ ─────────→ │          │
└──────────┘  支付结果   └──────────┘   物流更新   └──────────┘
     ↑                        │ ↑
     │         资金结算        │ │ 订单状态
     │                        ↓ │
     │                   ┌──────────┐
     └───────────────── │          │
           退款请求      │ 评价系统  │
                        │          │
                        └──────────┘
```

### 技术栈
- **前端**：微信小程序 + Taro + React
- **后端**：Node.js + 云函数（Tencent Cloud）
- **数据库**：MongoDB（云数据库）
- **支付系统**：微信支付 + Stripe + Apple Pay
- **即时通讯**：WebSocket + 云开发实时数据库

### 目录结构
```
├── app.js                 // 小程序入口文件
├── app.json               // 小程序全局配置
├── app.wxss               // 小程序全局样式
├── pages/                 // 页面文件夹
│   ├── chat/             // 聊天页面
│   ├── detail/           // 详情页面
│   ├── order/            // 订单页面
│   ├── profile/          // 个人中心
│   └── settings/         // 设置页面
├── cloudfunctions/        // 云函数
├── utils/                // 工具函数
├── images/               // 图片资源
├── styles/               // 公共样式
└── custom-tab-bar/        // 自定义底部导航栏
```

## 交互流程
1. 用户发布捎带请求，填写起点、终点、物品信息
2. 系统匹配可接单用户，或用户自行浏览可选捎带员
3. 双方确认捎带详情并支付押金
4. 捎带员完成任务后，用户确认收货，支付尾款
5. 交易完成，双方评分

## API 设计

### 统一响应格式
```json
{
  "success": true/false,  // 请求是否成功
  "data": {},             // 成功时返回的数据
  "error": "",            // 失败时返回的错误信息
  "code": 10001           // 错误码，仅在失败时返回
}
```

### 错误码设计
| 错误码 | 说明 |
|-------|------|
| 10001 | 参数错误 |
| 10002 | 用户未登录 |
| 10003 | 权限不足 |
| 20001 | 用户不存在 |
| 20002 | 密码错误 |
| 30001 | 订单创建失败 |
| 40001 | 支付失败 |
| 50001 | 系统错误 |

### 核心API示例

#### 1. 获取可接单列表
```
GET /api/orders?status=available
```
返回示例：
```json
{
  "success": true,
  "data": [
    {
      "orderId": "12345",
      "from": "北京",
      "to": "都柏林",
      "item": "文件",
      "reward": "€50",
      "status": "open"
    }
  ]
}
```

#### 2. 创建捎带订单
```
POST /api/orders
```
请求示例：
```json
{
  "from": "上海",
  "to": "科克",
  "item": "小包裹",
  "reward": "€30"
}
```

## 支付流程与资金安全

### 担保支付流程
```
sequenceDiagram
  participant 买家
  participant 平台
  participant 卖家
  
  买家->>平台: 1. 下单并支付
  平台->>平台: 2. 冻结买家资金
  平台->>卖家: 3. 通知订单已支付
  卖家->>买家: 4. 提供服务/发货
  买家->>平台: 5. 确认收货/服务完成
  平台->>卖家: 6. 释放资金给卖家
```

### 支付状态流转
| 状态 | 说明 | 触发条件 | 后续操作 |
|-----|------|--------|---------|
| pending_payment | 待支付 | 创建订单 | 用户付款或超时取消 |
| paid | 已支付 | 用户完成支付 | 卖家发货/提供服务 |
| completed | 已完成 | 买家确认收货/服务完成 | 系统结算给卖家 |
| cancelled | 已取消 | 买家取消或支付超时 | 退款(如已支付) |
| refunding | 退款中 | 买家申请退款 | 审核退款申请 |
| refunded | 已退款 | 退款申请通过并执行 | 订单结束 |

### 多支付方式支持
- **Apple Pay（欧元支付）**
  - 优先使用 Apple Pay
  - 自动检测设备是否支持
  - 支持欧元直接支付
- **微信支付（自动换算）**
  - 获取实时汇率
  - 欧元金额显示
  - 后台自动换算人民币
- **银行卡支付**
  - 支持 Visa/Mastercard（欧元）
  - 支持银联卡（自动换汇）

### 货币转换机制
- 实时汇率获取（对接汇率 API）
- 金额换算（欧元与人民币互转）
- 汇率保护（设置汇率波动阈值）

## 安全性考虑
- **身份认证**：所有用户需实名认证，防止恶意行为
- **支付安全**：使用第三方支付系统，确保资金安全
- **数据加密**：敏感信息加密存储，保护用户隐私
- **争议机制**：完善的争议处理流程，保障双方权益

### 数据加密存储策略
1. **敏感信息加密**：
   - 手机号、邮箱等使用AES-256加密存储
   - 密码使用SHA-256+盐值哈希存储，不保存明文
   - 支付信息使用非对称加密存储

2. **密钥管理**：
   - 加密密钥分离存储，不与数据库存储在同一位置
   - 定期轮换密钥，提高安全性

## 捎带交易流程

### 下单阶段
1. **发布需求**
   - 填写物品信息（类型、重量、尺寸）
   - 设置出发地和目的地
   - 设置期望时间和报酬金额

2. **接单流程**
   - 浏览捎带需求
   - 查看需求详情
   - 联系发布者
   - 确认接单并支付保证金

### 运输阶段
1. **物品交接**
   - 双方确认交接时间地点
   - 发布者上传物品照片
   - 接单者确认接收物品

2. **运输过程**
   - 接单者定期更新运输状态
   - 上传运输过程照片
   - 物流单号同步，可实时跟踪

### 交付阶段
1. **物品交付**
   - 接单者确认到达
   - 发布者确认物品完整性
   - 双方确认交付完成

2. **订单完成**
   - 发布者确认收货
   - 48小时未确认，系统自动放款
   - 接单者收到报酬
   - 双方互评

## 争议处理机制

### 争议类型与处理流程
- **未按时送达**：捎带人未在约定时间内完成送达
- **物品损坏**：物品在运输过程中损坏
- **物品丢失**：物品在运输过程中丢失
- **物品与描述不符**：收到的物品与发出时不一致

### 申诉流程
1. 在订单详情页提交申诉
2. 上传相关证据（照片、聊天记录）
3. 平台客服介入调查（24-48小时）
4. 给出处理方案并执行

### 赔付机制
- **全额赔付**：物品完全损毁或丢失
- **部分赔付**：根据损坏程度，按比例赔付
- **运费补偿**：物品需要退回时的运费补偿

## 国际物流支持

### 支持的快递服务商
- **国际快递**：DHL、UPS、FedEx、An Post（爱尔兰邮政）
- **爱尔兰本地快递**：Fastway、DPD Ireland、GLS Ireland

### 物流状态查询选项
- **自动查询**：通过API自动获取物流状态更新
- **手动输入**：用户手动输入物流单号和物流公司
- **混合模式**：支持API查询失败后回退到手动更新

## 多语言支持
- 支持中文和英文两种语言
- 根据用户设备语言自动切换
- 页面文案和错误提示全部支持双语

## 未来计划（ROADMAP）
- **自动匹配优化**：基于历史数据优化匹配算法
- **额外支付方式**：增加 PayPal 支持
- **多语言支持优化**：进一步完善UI的双语支持
- **合作航司对接**：尝试与航空公司合作，提高安全性和效率
- **会员体系**：引入会员等级，提供不同服务权益
- **保险服务**：为高价值物品提供额外保险选项

## 更新日志
- 2024-03-23：优化系统架构设计，增加性能优化和安全防护章节
- 2024-03-22：添加搜索和筛选功能、多语言支持和国际化
- 2024-03-20：添加多支付方式支持（Apple Pay、微信支付、银行卡）和货币转换功能
- 2024-03-19：优化物流管理，支持快递单号同步 & 48小时申诉机制
- 2024-03-18：添加担保支付、物流管理、信用评分和争议处理机制
- 2024-03-17：创建项目文档
- 2024-03-16：完成基础功能开发
- 2024-03-15：项目初始化 