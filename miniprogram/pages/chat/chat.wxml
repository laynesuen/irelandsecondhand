<view class="chat-container">
  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y="true" 
    bindscrolltoupper="onScrollToUpper"
    scroll-into-view="{{scrollToMessage ? 'msg-' + scrollToMessage : ''}}"
    enhanced="true"
    show-scrollbar="false"
    style="padding-bottom: {{keyboardHeight > 0 ? keyboardHeight : 0}}px">
    
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="loading-more" wx:if="{{loadingMore}}">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ -->
    <view class="no-more" wx:if="{{!hasMore && messages.length > 0 && !loadingMore}}">
      æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
    </view>
    
    <!-- æ¶ˆæ¯å†…å®¹ -->
    <view class="messages-wrapper">
      <view 
        wx:for="{{messages}}" 
        wx:key="_id"
        id="msg-{{item._id}}"
        class="message-item {{item.sender === userInfo._id ? 'self' : 'other'}}">
        
        <!-- å¤´åƒ -->
        <view class="avatar">
          <image 
            src="{{item.sender === userInfo._id ? userInfo.avatarUrl : targetUser.avatarUrl}}" 
            mode="aspectFill"
          ></image>
        </view>
        
        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <view class="message-content">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view 
            wx:if="{{item.type === 'text'}}" 
            class="message-bubble {{item.isFailed ? 'failed' : ''}}"
            bindtap="{{item.isFailed ? 'onRetryTap' : ''}}"
            data-id="{{item._id}}">
            {{item.content}}
            
            <!-- å‘é€å¤±è´¥å›¾æ ‡ -->
            <view wx:if="{{item.isFailed}}" class="failed-icon">!</view>
            
            <!-- å‘é€ä¸­å›¾æ ‡ -->
            <view wx:if="{{item.isPending}}" class="pending-icon"></view>
          </view>
          
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view wx:elif="{{item.type === 'image'}}" class="message-image">
            <image 
              src="{{item.content}}" 
              mode="widthFix" 
              bindtap="previewImage" 
              data-src="{{item.content}}"
            ></image>
            
            <!-- å‘é€å¤±è´¥å›¾æ ‡ -->
            <view wx:if="{{item.isFailed}}" class="failed-icon">!</view>
            
            <!-- å‘é€ä¸­å›¾æ ‡ -->
            <view wx:if="{{item.isPending}}" class="pending-icon"></view>
          </view>
          
          <!-- ä½ç½®æ¶ˆæ¯ -->
          <view wx:elif="{{item.type === 'location'}}" class="message-location">
            <view class="location-title">ä½ç½®ä¿¡æ¯</view>
            <view class="location-address">{{item.metadata.address}}</view>
            <map
              class="location-map"
              latitude="{{item.metadata.latitude}}"
              longitude="{{item.metadata.longitude}}"
              markers="{{[{latitude: item.metadata.latitude, longitude: item.metadata.longitude}]}}"
              scale="16"
            ></map>
            
            <!-- å‘é€å¤±è´¥å›¾æ ‡ -->
            <view wx:if="{{item.isFailed}}" class="failed-icon">!</view>
            
            <!-- å‘é€ä¸­å›¾æ ‡ -->
            <view wx:if="{{item.isPending}}" class="pending-icon"></view>
          </view>
          
          <!-- å…¶ä»–ç±»å‹æ¶ˆæ¯ -->
          <view wx:else class="message-bubble">
            æœªçŸ¥æ¶ˆæ¯ç±»å‹
          </view>
          
          <!-- æ¶ˆæ¯æ—¶é—´ -->
          <view class="message-time">
            {{item.createdAt}}
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½ä¸­ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    
    <!-- æ— æ¶ˆæ¯æç¤º -->
    <view class="empty-messages" wx:if="{{!loading && messages.length === 0}}">
      <view class="empty-icon">ğŸ’¬</view>
      <view class="empty-text">æš‚æ— æ¶ˆæ¯ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯å¼€å§‹èŠå¤©å§</view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥æ¡† -->
  <view class="input-container">
    <input 
      class="message-input" 
      type="text" 
      value="{{inputContent}}"
      placeholder="è¾“å…¥æ¶ˆæ¯..." 
      cursor-spacing="10"
      bindinput="onInputChange"
      confirm-type="send"
      bindconfirm="onSendTap"
    />
    <button 
      class="send-button {{inputContent ? 'active' : ''}}" 
      bindtap="onSendTap"
      disabled="{{!inputContent}}">
      å‘é€
    </button>
  </view>
</view> 