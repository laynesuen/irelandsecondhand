# Trae 小程序开发文档

## 项目概述
Trae 是一个专注于国际捎带服务的小程序，连接有捎带需求的用户和可以提供捎带服务的用户。用户可以在平台上发布捎带需求或提供捎带服务，实现物品的跨国捎带。

## 技术栈
- 微信小程序原生开发
- WebSocket 实时通信
- 微信支付接口

## 目录结构
```
├── app.js                 // 小程序入口文件
├── app.json              // 小程序全局配置
├── app.wxss              // 小程序全局样式
├── pages/                // 页面文件夹
│   ├── chat/            // 聊天页面
│   ├── detail/          // 详情页面
│   ├── order/           // 订单页面
│   ├── profile/         // 个人中心
│   └── settings/        // 设置页面
├── utils/               // 工具函数
├── images/              // 图片资源
├── styles/              // 公共样式
└── custom-tab-bar/      // 自定义底部导航栏
```

## 开发规范

### 命名规范
- 文件夹：小写字母，多个单词用连字符（-）连接
- 文件：小写字母，多个单词用连字符（-）连接
- 变量：驼峰命名法
- 常量：大写字母，多个单词用下划线（_）连接

### 代码规范
- 使用 ES6+ 语法特性
- 使用 Promise 处理异步操作
- 使用 async/await 处理异步流程
- 统一使用单引号
- 每行代码末尾不加分号

### 组件规范
- 组件名使用大驼峰命名法
- 组件文件结构：
  ```
  ├── components/
  │   └── ComponentName/
  │       ├── index.js
  │       ├── index.wxml
  │       ├── index.wxss
  │       └── index.json
  ```

### 页面规范
- 页面名使用小写字母，多个单词用连字符（-）连接
- 页面文件结构：
  ```
  ├── pages/
  │   └── page-name/
  │       ├── index.js
  │       ├── index.wxml
  │       ├── index.wxss
  │       └── index.json
  ```

## 功能模块

### 1. 用户认证
- 微信登录
- 手机号绑定
- 实名认证

### 2. 捎带服务
- 发布捎带需求
- 发布行程信息
- 搜索捎带服务
- 订单管理

### 3. 捎带交易流程
#### 3.1 下单阶段
1. 发布需求
   - 填写物品信息（类型、重量、尺寸）
   - 设置出发地和目的地
   - 设置期望时间
   - 设置报酬金额
   - 添加备注说明

2. 接单流程
   - 浏览捎带需求
   - 查看需求详情
   - 联系发布者
   - 确认接单
   - 系统创建订单

3. 支付流程
   - 发布者确认订单
   - 发布者支付报酬
   - 系统冻结支付金额（担保支付）
   - 等待捎带完成

#### 3.2 运输阶段
1. 物品交接
   - 双方确认交接时间地点
   - 发布者上传物品照片
   - 接单者确认接收物品
   - 系统记录交接状态

2. 运输过程
   - 接单者定期更新运输状态
   - 上传运输过程照片
   - 记录重要节点时间
   - 物流单号同步，需求人 & 捎带人可跟踪

3. 异常处理
   - 运输延误处理
   - 物品损坏处理
   - 路线变更处理
   - 紧急情况处理

#### 3.3 交付阶段
1. 到达通知
   - 接单者确认到达
   - 系统通知发布者
   - 确认交付时间地点

2. 物品交付
   - 发布者确认物品完整性
   - 接单者上传交付照片
   - 双方确认交付完成
   - 系统更新订单状态

3. 订单完成
   - 发布者确认收货
   - 48小时未确认，系统自动放款
   - 接单者收到报酬
   - 双方互评

4. 售后服务
   - 物品问题处理
   - 投诉处理
   - 退款处理
   - 保险理赔

### 4. 即时通讯
- WebSocket 实时聊天
- 消息类型：文本、图片、订单、位置
- 消息状态管理

### 5. 支付功能
- 微信支付集成
- 订单支付流程
- 退款处理
- 担保支付机制
  - 资金托管
  - 支付流程：
    1. 发布者支付报酬到平台托管账户
    2. 系统冻结托管资金
    3. 订单完成后自动解冻并支付给接单者
    4. 异常情况平台介入处理
  - 安全保障：
    - 资金全程托管
    - 交易过程可追溯
    - 异常情况快速处理
    - 平台担保赔付
- 多支付方式支持
  - Apple Pay（欧元支付）
    - 优先使用 Apple Pay
    - 自动检测设备是否支持
    - 支持欧元直接支付
    - 不可用时自动切换其他方式
  - 微信支付（自动换算）
    - 获取实时汇率
    - 欧元金额显示
    - 后台自动换算人民币
    - 支付时显示欧元金额
  - 银行卡支付
    - 支持 Visa/Mastercard（欧元）
    - 支持银联卡（自动换汇）
    - 支付失败时自动切换
    - 支持多币种结算
- 货币转换机制
  - 实时汇率获取
    - 对接汇率 API
    - 定时更新汇率
    - 缓存汇率数据
    - 异常时使用备用汇率
  - 金额换算
    - 欧元转人民币
    - 人民币转欧元
    - 保留两位小数
    - 四舍五入处理
  - 汇率保护
    - 设置汇率波动阈值
    - 超出阈值时提醒
    - 支持手动确认
    - 记录汇率历史

### 6. 物流管理
- 快递单号录入
  - 需求人寄出物品，填写快递单号
  - 捎带人确认收到，开始运输
  - 交付后，捎带人填写快递单号，需求人可追踪
- 物流状态追踪
  - 自动同步快递物流信息
  - 重要节点时间记录
  - 异常状态提醒
  - 物流轨迹回放
- 物流信息管理
  - 快递单号管理
  - 物流公司选择
  - 运费计算
  - 物流凭证保存

### 7. 信用评分系统
- 评分维度
  - 准时率评分（40%）
    - 按时交接
    - 按时送达
    - 时间承诺履行
  - 完好率评分（30%）
    - 物品完整性
    - 包装完好度
    - 运输保护
  - 沟通评分（30%）
    - 回复及时性
    - 沟通态度
    - 问题解决能力
- 评分规则
  - 订单完成后双方互评
  - 评分范围：1-5星
  - 文字评价（选填）
  - 图片评价（选填）
- 信用等级
  - 优秀（4.5-5星）
  - 良好（4-4.4星）
  - 一般（3-3.9星）
  - 较差（2-2.9星）
  - 差（1-1.9星）
- 信用限制
  - 低于3星限制接单
  - 低于2星限制发布需求
  - 低于1.5星账号冻结
  - 信用恢复机制

### 8. 争议处理机制
- 申诉流程
  - 48小时内发起申诉
  - 提交申诉材料
    - 问题描述
    - 相关证据
    - 诉求说明
  - 客服介入处理
    - 24小时内响应
    - 48小时内处理
    - 72小时内结案
- 处理方式
  - 平台判定责任，可能退款或部分赔偿
  - 低评分用户限制接单
- 申诉结果
  - 申诉成功：更新订单状态，执行处理方案
  - 申诉失败：提供说明，记录信用评分

### 9. 个人中心
- 个人信息管理
- 订单历史
- 收藏管理
- 设置中心

## API 接口

### 用户相关
- 登录接口
- 获取用户信息
- 更新用户信息

### 订单相关
- 创建订单
- 获取订单列表
- 获取订单详情
- 更新订单状态

### 支付相关
- 创建支付订单
- 获取支付参数
- 支付结果回调
- 获取实时汇率
- 货币转换计算
- 支付方式检测
- 支付状态查询

## 开发流程

### 1. 环境搭建
1. 安装微信开发者工具
2. 克隆项目代码
3. 导入项目到开发者工具
4. 配置开发者信息

### 2. 开发流程
1. 创建功能分支
2. 开发功能
3. 代码审查
4. 合并到主分支
5. 测试验证
6. 发布上线

### 3. 发布流程
1. 版本号更新
2. 代码审查
3. 测试验证
4. 提交审核
5. 发布上线

## 注意事项
1. 所有敏感信息（如密钥、token）必须通过配置文件管理
2. 图片资源需要压缩优化
3. 网络请求需要做好错误处理
4. 用户数据需要做好安全保护
5. 支付相关功能需要严格测试
6. 担保支付资金安全
7. 物流信息及时更新
8. 信用评分公平公正
9. 争议处理及时有效

## 常见问题
1. WebSocket 连接断开处理
2. 支付失败处理
3. 图片上传失败处理
4. 网络请求超时处理
5. 物流信息异常处理
6. 信用评分争议处理
7. 申诉处理流程
8. 资金托管问题

## 更新日志
- 2024-03-17：创建项目文档
- 2024-03-16：完成基础功能开发
- 2024-03-15：项目初始化
- 2024-03-18：添加担保支付、物流管理、信用评分和争议处理机制
- 2024-03-19：优化物流管理，支持快递单号同步 & 48小时申诉机制
- 2024-03-20：添加多支付方式支持（Apple Pay、微信支付、银行卡）和货币转换功能 